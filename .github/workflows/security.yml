name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    name: Security Vulnerability Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev,security]"

      - name: Run pip-audit (PyPA Official)
        run: |
          uv pip install --system pip-audit
          # Generate JSON report for artifact
          pip-audit --desc --format json --output pip-audit-report.json || true
          # Run with human-readable output and fail on vulnerabilities
          echo "Running pip-audit with vulnerability detection..."
          pip-audit --desc --strict || {
            echo "::warning::pip-audit found vulnerabilities in dependencies"
            exit 1
          }

      - name: Run Ruff Security Rules
        run: |
          ruff check --select S --output-format json pytest_jux/ > ruff-security-report.json || true
          ruff check --select S pytest_jux/
        continue-on-error: true

      - name: Run Safety (Vulnerability Scanner)
        run: |
          # Safety CLI now requires authentication for most features
          # Use pip-audit instead (official PyPA tool, no auth required)
          echo "Note: Safety CLI requires authentication. Using pip-audit for vulnerability scanning."
          echo "pip-audit results are available in the pip-audit-report artifact."
        continue-on-error: true
      
      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit-report.json

      - name: Upload Ruff Security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ruff-security-report
          path: ruff-security-report.json

  
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
  
  trivy-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail build on critical/high vulnerabilities
          ignore-unfixed: true  # Only fail on fixable issues

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true  # Code scanning requires GitHub Advanced Security (not available for private repos on free tier)
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Upload Trivy results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-results
          path: trivy-results.sarif
  
  sbom-validation:
    name: SBOM Validation & Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install cyclonedx-bom
        run: |
          uv pip install --system cyclonedx-bom

      - name: Generate SBOM
        run: |
          cyclonedx-py requirements \
            --pyproject pyproject.toml \
            --of JSON \
            --output-file pytest-jux-sbom.cdx.json

          echo "Generated SBOM:"
          ls -lh pytest-jux-sbom.cdx.json

      - name: Install CycloneDX CLI (via npm)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install cyclonedx-cli
        run: |
          npm install -g @cyclonedx/cyclonedx-cli

      - name: Validate SBOM
        run: |
          cyclonedx-cli validate \
            --input-file pytest-jux-sbom.cdx.json \
            --fail-on-errors

          echo "âœ“ SBOM validation passed"

      - name: Analyze SBOM
        run: |
          echo "SBOM Analysis:"
          cyclonedx-cli analyze \
            --input-file pytest-jux-sbom.cdx.json || echo "Analysis command not available"

          # Show component count
          echo "Component count:"
          cat pytest-jux-sbom.cdx.json | \
            python -c "import sys, json; data=json.load(sys.stdin); print(f'Total components: {len(data.get(\"components\", []))}')"

      - name: Audit dependencies from SBOM
        run: |
          uv pip install --system pip-audit

          # Convert SBOM to requirements.txt format
          cyclonedx-cli convert \
            --input-file pytest-jux-sbom.cdx.json \
            --output-format requirements.txt \
            --output-file sbom-requirements.txt || {
              echo "Warning: SBOM conversion not available in this version of cyclonedx-cli"
              echo "Falling back to direct pip-audit scan"
            }

          # Audit dependencies
          if [ -f sbom-requirements.txt ]; then
            pip-audit -r sbom-requirements.txt --desc --strict
          else
            # Fallback: audit installed packages
            pip-audit --desc --strict
          fi

      - name: Upload SBOM artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: pytest-jux-sbom.cdx.json

  security-tests:
    name: Security Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Run security tests
        run: |
          if [ -d "tests/security" ]; then
            pytest tests/security/ -v --tb=short --no-cov
          else
            echo "No security tests found - skipping"
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-coverage
          path: htmlcov/
  
  scorecard:
    name: OpenSSF Scorecard
    runs-on: ubuntu-latest
    # OpenSSF Scorecard has limited support for private repositories
    # Skip this job for private repos to avoid API permission errors
    if: github.event.repository.private == false
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@v2.4.0
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true
      
      - name: Upload Scorecard results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: scorecard-results.sarif
      
      - name: Upload Scorecard results artifact
        uses: actions/upload-artifact@v4
        with:
          name: scorecard-results
          path: scorecard-results.sarif
