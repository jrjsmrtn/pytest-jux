# pytest-jux v0.3.0 - Metadata Integration

**Release Date**: 2025-10-24
**Type**: Major Feature Release (Breaking Changes)

## üö® Breaking Changes

This release fundamentally changes how metadata is stored and managed in pytest-jux.

### Metadata Storage Architecture

**Before (v0.2.x)**:
- Metadata stored in separate JSON sidecar files (`.jux/reports/metadata/`)
- JSON files not included in XMLDSig signature
- Metadata could be separated from test reports

**After (v0.3.0)**:
- Metadata embedded in JUnit XML `<properties>` elements
- All metadata cryptographically signed with XMLDSig
- Single source of truth: metadata in XML file only
- **JSON sidecar files removed** (no longer generated)

### Migration Guide

**If you're upgrading from v0.2.x**:

1. **Existing reports remain valid**: Old signed reports with JSON sidecars are still valid and verifiable
2. **New reports use XML-only**: Reports generated with v0.3.0+ will not have JSON sidecars
3. **Cache directory structure**: The `.jux/reports/metadata/` directory is no longer used
4. **Code changes**: If you were reading metadata from JSON files, update to parse XML `<properties>` instead

**Example: Reading metadata from XML**:
```python
from lxml import etree

# Load signed report
tree = etree.parse("report.xml")
properties = tree.find(".//properties")

# Extract metadata
for prop in properties.findall("property"):
    name = prop.get("name")
    value = prop.get("value")
    print(f"{name}: {value}")
```

## ‚ú® What's New

### 1. pytest-metadata Integration (ADR-0011)

pytest-jux now integrates with [pytest-metadata](https://github.com/pytest-dev/pytest-metadata) to automatically capture and embed environment metadata into test reports.

**Zero Configuration Required**: Metadata is automatically captured when you run pytest with JUnit XML output:

```bash
pytest --junit-xml=report.xml --jux-sign
```

### 2. Mandatory Project Name Capture

Every test report now includes a **project name** (mandatory field) with intelligent fallback strategies:

1. **Git remote URL**: Extracts repository name from `origin` remote
   - `https://github.com/owner/my-project.git` ‚Üí `my-project`
2. **pyproject.toml**: Reads from `[project] name` or `[tool.poetry] name`
3. **Environment variable**: `JUX_PROJECT_NAME`
4. **Directory basename**: Current directory name (final fallback)

**XML Output**:
```xml
<property name="project" value="my-project"/>
```

### 3. Git Metadata Auto-Detection

Automatically captures git repository context when running tests in a git repository:

- **git:commit**: Full commit SHA
- **git:branch**: Current branch name
- **git:status**: Working tree status (`clean` or `dirty`)
- **git:remote**: Remote URL (credentials sanitized)

**Features**:
- Multi-remote support: Tries `origin`, `home`, `upstream`, `github`, `gitlab`
- Credential sanitization: Automatically removes credentials from remote URLs
- Graceful fallback: Returns `None` if not in a git repository

**XML Output**:
```xml
<property name="git:commit" value="abc123def456..."/>
<property name="git:branch" value="main"/>
<property name="git:status" value="clean"/>
<property name="git:remote" value="https://github.com/owner/repo.git"/>
```

### 4. CI Provider Auto-Detection

Automatically detects CI environment and captures build metadata for **5 major CI providers**:

- **GitHub Actions**: `ci:provider=github`, `GITHUB_RUN_ID`, `GITHUB_SERVER_URL`
- **GitLab CI**: `ci:provider=gitlab`, `CI_PIPELINE_ID`, `CI_PIPELINE_URL`
- **Jenkins**: `ci:provider=jenkins`, `BUILD_ID`, `BUILD_URL`
- **Travis CI**: `ci:provider=travis`, `TRAVIS_BUILD_ID`, `TRAVIS_BUILD_WEB_URL`
- **CircleCI**: `ci:provider=circleci`, `CIRCLE_BUILD_NUM`, `CIRCLE_BUILD_URL`

**XML Output**:
```xml
<property name="ci:provider" value="github"/>
<property name="ci:build_id" value="123456"/>
<property name="ci:build_url" value="https://github.com/owner/repo/actions/runs/123456"/>
```

### 5. CI Environment Variables Auto-Capture

CI-specific environment variables are automatically captured and embedded:

- **GitHub Actions**: `GITHUB_SHA`, `GITHUB_REF`, `GITHUB_ACTOR`
- **GitLab CI**: `CI_COMMIT_SHA`, `CI_PIPELINE_ID`, `CI_JOB_ID`
- **Jenkins**: `GIT_COMMIT`, `BUILD_NUMBER`, `JOB_NAME`
- **Travis CI**: `TRAVIS_COMMIT`, `TRAVIS_BUILD_NUMBER`
- **CircleCI**: `CIRCLE_SHA1`, `CIRCLE_WORKFLOW_ID`

**XML Output**:
```xml
<property name="env:GITHUB_SHA" value="abc123def456..."/>
<property name="env:GITHUB_REF" value="refs/heads/main"/>
<property name="env:GITHUB_ACTOR" value="jrjsmrtn"/>
```

### 6. Semantic Namespace Prefixes

Metadata is organized with semantic prefixes for clarity:

- **No prefix**: Project name (`project="my-project"`)
- **jux:**: Core pytest-jux metadata (`jux:hostname`, `jux:timestamp`)
- **git:**: Git metadata (`git:commit`, `git:branch`)
- **ci:**: CI provider metadata (`ci:provider`, `ci:build_id`)
- **env:**: Environment variables (`env:GITHUB_SHA`)

### 7. Cryptographic Metadata Provenance

**All metadata is included in the XMLDSig signature**, ensuring:
- ‚úÖ Tamper-proof metadata (cryptographic integrity)
- ‚úÖ Complete test report provenance
- ‚úÖ Traceable build and environment context
- ‚úÖ Reproducible test execution environment

## üìö Documentation Updates

### New Documentation

- **ADR-0011**: [Integrate pytest-metadata](docs/adr/0011-integrate-metadata-with-pytest-metadata.md) - Architecture decision record
- **Sprint 7 Plan**: [Metadata Integration Sprint](docs/sprints/sprint-07-metadata-integration.md)

### Updated Documentation

- **[How-To: Add Metadata to Reports](docs/howto/add-metadata-to-reports.md)** - Updated with git/CI auto-detection
- **[API Reference: metadata](docs/reference/api/metadata.md)** - Complete rewrite (517 lines)
- **[API Reference: storage](docs/reference/api/storage.md)** - Updated for XML-only metadata

## üì¶ Example: Complete Metadata Output

```xml
<testsuite>
  <properties>
    <!-- Project name (mandatory) -->
    <property name="project" value="pytest-jux"/>

    <!-- Core jux metadata -->
    <property name="jux:hostname" value="ci-runner-01"/>
    <property name="jux:username" value="gitlab-runner"/>
    <property name="jux:platform" value="Linux-5.15.0"/>
    <property name="jux:python_version" value="3.11.4"/>
    <property name="jux:pytest_version" value="8.4.2"/>
    <property name="jux:pytest_jux_version" value="0.3.0"/>
    <property name="jux:timestamp" value="2025-10-24T12:34:56+00:00"/>

    <!-- Git metadata (auto-detected) -->
    <property name="git:commit" value="abc123def456..."/>
    <property name="git:branch" value="main"/>
    <property name="git:status" value="clean"/>
    <property name="git:remote" value="https://github.com/jux-tools/pytest-jux.git"/>

    <!-- CI metadata (auto-detected) -->
    <property name="ci:provider" value="github"/>
    <property name="ci:build_id" value="123456"/>
    <property name="ci:build_url" value="https://github.com/jux-tools/pytest-jux/actions/runs/123456"/>

    <!-- Environment variables (auto-captured) -->
    <property name="env:GITHUB_SHA" value="abc123def456..."/>
    <property name="env:GITHUB_REF" value="refs/heads/main"/>
    <property name="env:GITHUB_ACTOR" value="jrjsmrtn"/>
  </properties>

  <!-- XMLDSig signature covers all metadata -->
  <ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
    <!-- Signature data ensures metadata integrity -->
  </ds:Signature>

  <!-- Test results -->
  <testcase classname="tests.test_example" name="test_something" time="0.001"/>
</testsuite>
```

## üîß Technical Details

### Dependencies

- **New dependency**: `pytest-metadata>=3.1` (auto-installed)
- **Python**: 3.11+ (unchanged)
- **pytest**: 7.4+ (unchanged)

### Test Coverage

- **381 tests passing** (9 skipped, 16 xfailed)
- **89.11% code coverage** (93.75% on metadata.py)
- **43 new tests** for git/CI metadata auto-detection

### Files Changed

- **23 files changed**: +4,390 insertions, -1,010 deletions
- **New files**:
  - `docs/adr/0011-integrate-metadata-with-pytest-metadata.md`
  - `docs/sprints/sprint-07-metadata-integration.md`
  - `tests/test_metadata_integration.py`

## üéØ Use Cases

### CI/CD Pipeline Traceability

```bash
# GitLab CI
pytest --junit-xml=report.xml --jux-sign --jux-publish

# Automatically captures:
# - Project name (from git remote or pyproject.toml)
# - Git commit, branch, status, remote
# - CI provider: gitlab
# - CI build ID: $CI_PIPELINE_ID
# - CI build URL: $CI_PIPELINE_URL
# - CI env vars: CI_COMMIT_SHA, CI_JOB_ID, etc.
```

### Local Development

```bash
# Local developer machine
pytest --junit-xml=report.xml --jux-sign

# Automatically captures:
# - Project name (from git remote)
# - Git commit, branch, status (if in git repo)
# - Hostname, username, platform
# - Python/pytest versions
```

### Metadata Override

User-provided metadata takes precedence over auto-detected metadata:

```bash
# Override hostname for containerized environments
pytest --junit-xml=report.xml \
  --metadata jux:hostname "docker-runner" \
  --metadata project "custom-project-name"
```

## üîó Links

- **Full Changelog**: [CHANGELOG.md](CHANGELOG.md#030---2025-10-24)
- **Documentation**: [docs/](docs/)
- **ADR-0011**: [Integrate pytest-metadata](docs/adr/0011-integrate-metadata-with-pytest-metadata.md)
- **Sprint 7 Plan**: [Sprint 7 Documentation](docs/sprints/sprint-07-metadata-integration.md)

## ‚ö†Ô∏è Known Issues

None reported for v0.3.0.

## üìù Contributors

- **Georges Martin** ([@jrjsmrtn](https://github.com/jrjsmrtn)) - Sprint 7 implementation

---

**Install**: `pip install pytest-jux==0.3.0`
**Upgrade**: `pip install --upgrade pytest-jux`

For questions or issues, please [open an issue](https://github.com/jux-tools/pytest-jux/issues).
